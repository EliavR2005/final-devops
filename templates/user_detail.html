<!-- user_detail.html-->
{% extends "base.html" %}
{% block title %}Detalles de {{ user.username }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='details-user.css') }}">

<h1>Detalles de {{ user.username }}</h1>
<ul id="user-data-list">
  <li>Nombre: {{ user.name }}</li>
  <li>Email: <span id="field-email">{{ data.email }}</span></li>
  <li>Dirección: <span id="field-address">{{ data.address }}</span></li>
  <li>Teléfono: <span id="field-phone">{{ data.phone }}</span></li>
  <li>RFC: <span id="field-rfc">{{ data.rfc }}</span></li>
  <li>Fecha de nacimiento: {{ user.birth_date }}</li>
  <li>Género: {{ user.gender }}</li>
</ul>

<div class="button-row">
  <a href="{{ url_for('dashboard') }}"><button>← Volver al Dashboard</button></a>
  {% if current_user.role == 'admin' %}
    <button id="openViewModalBtn" data-username="{{ user.username }}">Desencriptar datos</button>
    <button id="openEditModalBtn" data-username="{{ user.username }}">Editar</button>
  {% endif %}
</div>

<!-- Modal para contraseña -->
<dialog id="passModal">
  <form id="passForm">
    <label>Contraseña admin:
      <input id="adminPass" name="admin_password" type="password" required>
    </label>
    <menu>
      <button type="button" id="cancelBtn">Cancelar</button>
      <button type="submit">Enviar</button>
    </menu>
  </form>
</dialog>

<!-- Contenedor de edición oculto -->
<div id="editFormContainer" style="display:none; margin-top:1rem;">
  <form id="editForm" method="POST" action="{{ url_for('edit_user', username=user.username) }}" style="display:grid; gap:1rem; max-width:600px;">
    <label>Nombre:<input type="text" name="name" value="{{ user.name }}" required /></label>
    <label>Email:<input type="email" name="email" value="{{ data.email }}" required /></label>
    <label>Dirección:<input type="text" name="address" value="{{ data.address }}" /></label>
    <label>Teléfono:<input type="tel" name="phone" value="{{ data.phone }}" /></label>
    <label>RFC:<input type="text" name="rfc" value="{{ data.rfc }}" required /></label>
    <label>Fecha de nacimiento:<input type="date" name="birth_date" value="{{ user.birth_date }}" required /></label>
    <label>Género:
      <select name="gender">
        <option value="Male" {% if user.gender=='Male' %}selected{% endif %}>Male</option>
        <option value="Female" {% if user.gender=='Female' %}selected{% endif %}>Female</option>
        <option value="Other" {% if user.gender=='Other' %}selected{% endif %}>Other</option>
      </select>
    </label>
    <div style="display:flex; gap:1rem; justify-content:flex-end;">
      <button type="button" id="cancelEditBtn">Cancelar</button>
      <button type="submit">Guardar cambios</button>
    </div>
  </form>
</div>

<script>
const modal = document.getElementById('passModal');
const form = document.getElementById('passForm');
const adminPassInput = document.getElementById('adminPass');
let targetUsername = null;
let currentAction = null;

// Abrir modal para view o edit
['openViewModalBtn','openEditModalBtn'].forEach(id=>{
  document.getElementById(id)?.addEventListener('click', e=>{
    const btn = e.currentTarget;
    targetUsername = btn.dataset.username;
    currentAction = (id==='openViewModalBtn') ? 'view' : 'edit';
    modal.showModal();
  });
});

// Cancelar modal
document.getElementById('cancelBtn').addEventListener('click', ()=> modal.close());

// Submit contraseña
form.addEventListener('submit', async e=>{
  e.preventDefault(); modal.close();
  const pwd = adminPassInput.value; adminPassInput.value='';

  const resp = await fetch(`{{ url_for('view_user_encrypted', username='__USER__') }}`.replace('__USER__', targetUsername), {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({admin_password:pwd})
  });
  const data = await resp.json();
  if(!resp.ok){ alert(data.error); return; }

  if(currentAction==='view'){
    document.getElementById('field-email').textContent = data.email;
    document.getElementById('field-address').textContent = data.address;
    document.getElementById('field-phone').textContent = data.phone;
    document.getElementById('field-rfc').textContent = data.rfc;
  } else {
    document.getElementById('editFormContainer').style.display='block';
  }
});

// Cancelar edición
document.getElementById('cancelEditBtn').addEventListener('click', ()=>{
  document.getElementById('editFormContainer').style.display='none';
});
</script>
{% endblock %}
